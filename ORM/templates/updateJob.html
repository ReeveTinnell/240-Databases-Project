{% include "header.html" %}

    <style>
        .form-group { margin-bottom: 15px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0;
                 width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px;
                        border: 1px solid #888; width: 50%; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <h1>Edit Job</h1>

    <form method="POST" id="jobForm">
        <!-- Basic Job Info -->
        <div class="form-group">
            <label>Job Title*:</label>
            <input type="text" name="title" id="jobTitle" value="{{ job.title }}" required>
        </div>

        <div class="form-group">
            <label>Post Date:</label>
            <input type="date" name="post_date" id="postDate" value="{{ job.post_date }}">
        </div>

        <div class="form-group">
            <label>Close Date:</label>
            <input type="date" name="close_date" id="closeDate" value="{{ job.close_date }}">
        </div>

        <div class="form-group">
            <label>Job Link:</label>
            <input type="url" name="hyperlink" id="hyperlink" value="{{ job.hyperlink }}">
        </div>

        <!-- Company (Required) -->
        <div class="form-group">
            <label>Company*:</label>
            <select name="company_id" id="companySelect" required>
                <option value="">Select a company</option>
                {% for company in companies %}
                <option value="{{ company.id }}" {% if company.id == job.company_id %}selected{% endif %}>
                    {{ company.name }}
                </option>
                {% endfor %}
            </select>
            <button type="button" onclick="openModal('companyModal')">+ Add New Company</button>
        </div>

        <!-- Role (Optional) -->
        <div class="form-group">
            <label>Role:</label>
            <select name="role_id" id="roleSelect">
                <option value="">Select a role</option>
                {% for role in roles %}
                <option value="{{ role.id }}" {% if role.id == job.role_id %}selected{% endif %}>
                    {{ role.title }}
                </option>
                {% endfor %}
            </select>
            <button type="button" onclick="openModal('roleModal')">+ Add New Role</button>
        </div>

        <!-- Contact (Optional) -->
        <div class="form-group">
            <label>Contact:</label>
            <select name="contact_id" id="contactSelect">
                <option value="">Select a contact</option>
                {% for contact in contacts %}
                <option value="{{ contact.id }}" {% if contact.id == job.contact_id %}selected{% endif %}>
                    {{ contact.name }} ({{ contact.email }})
                </option>
                {% endfor %}
            </select>
            <button type="button" onclick="openModal('contactModal')">+ Add New Contact</button>
        </div>

            <!-- Job Type -->
        <div class="form-group">
            <label>Job Type*:</label>
            <select name="job_type" id="jobTypeSelect" required onchange="toggleJobTypeFields()">
                <option value="">Select job type</option>
                <option value="full_time" {% if job.ft %}selected{% endif %}>Full Time</option>
                <option value="part_time" {% if job.pt %}selected{% endif %}>Part Time</option>
                <option value="contract" {% if job.contract %}selected{% endif %}>Contract</option>
            </select>
        </div>

        <!-- Full Time Fields -->
        <div id="fullTimeFields" class="{% if not job.ft %}hidden{% endif %}">
            <h3>Full Time Details</h3>
            <div class="form-group">
                <label>Hourly Rate:</label>
                <input type="number" step="0.01" name="ft_hourly" value="{{ job.ft.hourly if job.ft else '' }}">
            </div>
            <div class="form-group">
                <label>Schedule:</label>
                <textarea name="ft_schedule">{{ job.ft.schedule if job.ft else '' }}</textarea>
            </div>
            <div class="form-group">
                <label>Benefits:</label>
                <textarea name="benefits">{{ job.ft.benefits if job.ft else '' }}</textarea>
            </div>
        </div>

        <!-- Part Time Fields -->
        <div id="partTimeFields" class="{% if not job.pt %}hidden{% endif %}">
            <h3>Part Time Details</h3>
            <div class="form-group">
                <label>Hourly Rate:</label>
                <input type="number" step="0.01" name="pt_hourly" value="{{ job.pt.hourly if job.pt else '' }}">
            </div>
            <div class="form-group">
                <label>Schedule:</label>
                <textarea name="pt_schedule">{{ job.pt.schedule if job.pt else '' }}</textarea>
            </div>
            <div class="form-group">
                <label>Weekly Hours:</label>
                <input type="number" name="weeklyHours" value="{{ job.pt.weeklyHours if job.pt else '' }}">
            </div>
        </div>

        <!-- Contract Fields -->
        <div id="contractFields" class="{% if not job.contract %}hidden{% endif %}">
            <h3>Contract Details</h3>
            <div class="form-group">
                <label>Terms:</label>
                <textarea name="terms">{{ job.contract.terms if job.contract else '' }}</textarea>
            </div>
            <div class="form-group">
                <label>Schedule:</label>
                <textarea name="contract_schedule">{{ job.contract.schedule if job.contract else '' }}</textarea>
            </div>
            <div class="form-group">
                <label>Pay:</label>
                <input type="text" name="pay" value="{{ job.contract.pay if job.contract else '' }}">
            </div>
        </div>

        <!-- Certifications (Many-to-Many) -->
        <div class="form-group">
            <label>Required Certifications:</label>
            <div id="certCheckboxes">
                {% for cert in certs %}
                <div>
                    <input type="checkbox" name="cert_ids" value="{{ cert.id }}" id="cert_{{ cert.id }}"
                        {% if cert in job.certs %}checked{% endif %}>
                    <label for="cert_{{ cert.id }}">{{ cert.name }}</label>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="openModal('certModal')">+ Add New Certification</button>
        </div>

        <button type="submit">Update Job</button>
        <a href="/jobs"><button type="button">Cancel</button></a>
    </form>

    <!-- Modals for Creating New Entities -->

    <!-- Company Modal -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('companyModal')">&times;</span>
            <h2>Add New Company</h2>
            <form id="companyForm">
                <div class="form-group">
                    <label>Company Name*:</label>
                    <input type="text" id="companyName" required>
                </div>
                <div class="form-group">
                    <label>Industry:</label>
                    <input type="text" id="companyIndustry">
                </div>
                <div class="form-group">
                    <label>Location:</label>
                    <input type="text" id="companyLocation">
                </div>
                <div class="form-group">
                    <label>Size:</label>
                    <input type="text" id="companySize">
                </div>
                <div class="form-group">
                    <label>Website:</label>
                    <input type="url" id="companyWebsite">
                </div>
                <button type="button" onclick="createCompany()">Save Company</button>
                <button type="button" onclick="closeModal('companyModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Role Modal -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('roleModal')">&times;</span>
            <h2>Add New Role</h2>
            <form id="roleForm">
                <div class="form-group">
                    <label>Role Title*:</label>
                    <input type="text" id="roleTitle" required>
                </div>
                <div class="form-group">
                    <label>Average Wage:</label>
                    <input type="number" step="0.01" id="roleAvgWage">
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="roleDescription"></textarea>
                </div>
                <button type="button" onclick="createRole()">Save Role</button>
                <button type="button" onclick="closeModal('roleModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('contactModal')">&times;</span>
            <h2>Add New Contact</h2>
            <form id="contactForm">
                <div class="form-group">
                    <label>Company*:</label>
                    <select id="contactCompany" required>
                        <option value="">Select company</option>
                        {% for company in companies %}
                        <option value="{{ company.id }}">{{ company.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="contactName">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="contactEmail">
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" id="contactPhone">
                </div>
                <div class="form-group">
                    <label>Position:</label>
                    <input type="text" id="contactPosition">
                </div>
                <button type="button" onclick="createContact()">Save Contact</button>
                <button type="button" onclick="closeModal('contactModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Cert Modal -->
    <div id="certModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('certModal')">&times;</span>
            <h2>Add New Certification</h2>
            <form id="certForm">
                <div class="form-group">
                    <label>Certification Name*:</label>
                    <input type="text" id="certName" required>
                </div>
                <div class="form-group">
                    <label>Certifying Body*:</label>
                    <input type="text" id="certBody" required>
                </div>
                <div class="form-group">
                    <label>Cost:</label>
                    <input type="number" step="0.01" id="certCost">
                </div>
                <div class="form-group">
                    <label>Requirements:</label>
                    <textarea id="certRequirements"></textarea>
                </div>
                <div class="form-group">
                    <label>Link:</label>
                    <input type="url" id="certLink">
                </div>
                <button type="button" onclick="createCert()">Save Certification</button>
                <button type="button" onclick="closeModal('certModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function toggleJobTypeFields() {
            const jobType = document.getElementById('jobTypeSelect').value;
            document.getElementById('fullTimeFields').classList.add('hidden');
            document.getElementById('partTimeFields').classList.add('hidden');
            document.getElementById('contractFields').classList.add('hidden');

            if (jobType === 'full_time') {
                document.getElementById('fullTimeFields').classList.remove('hidden');
            } else if (jobType === 'part_time') {
                document.getElementById('partTimeFields').classList.remove('hidden');
            } else if (jobType === 'contract') {
                document.getElementById('contractFields').classList.remove('hidden');
            }
        }

        async function createCompany() {
            const data = {
                name: document.getElementById('companyName').value,
                industry: document.getElementById('companyIndustry').value,
                location: document.getElementById('companyLocation').value,
                size: document.getElementById('companySize').value,
                website: document.getElementById('companyWebsite').value
            };

            const response = await fetch('/api/company', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            // Add to dropdown
            const select = document.getElementById('companySelect');
            const option = new Option(result.name, result.id);
            select.add(option);
            select.value = result.id;

            // Also update contact modal company dropdown
            const contactCompanySelect = document.getElementById('contactCompany');
            contactCompanySelect.add(new Option(result.name, result.id));

            closeModal('companyModal');
            document.getElementById('companyForm').reset();
        }

        async function createRole() {
            const data = {
                title: document.getElementById('roleTitle').value,
                avg_wage: document.getElementById('roleAvgWage').value,
                description: document.getElementById('roleDescription').value
            };

            const response = await fetch('/api/role', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            const select = document.getElementById('roleSelect');
            const option = new Option(result.title, result.id);
            select.add(option);
            select.value = result.id;

            closeModal('roleModal');
            document.getElementById('roleForm').reset();
        }

        async function createContact() {
            const data = {
                company_id: document.getElementById('contactCompany').value,
                name: document.getElementById('contactName').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                position: document.getElementById('contactPosition').value
            };

            const response = await fetch('/api/contact', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            const select = document.getElementById('contactSelect');
            const option = new Option(result.name, result.id);
            select.add(option);
            select.value = result.id;

            closeModal('contactModal');
            document.getElementById('contactForm').reset();
        }

        async function createCert() {
            const data = {
                name: document.getElementById('certName').value,
                cert_body: document.getElementById('certBody').value,
                cost: document.getElementById('certCost').value,
                requirements: document.getElementById('certRequirements').value,
                link: document.getElementById('certLink').value
            };

            const response = await fetch('/api/cert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            // Add checkbox to list
            const container = document.getElementById('certCheckboxes');
            const div = document.createElement('div');
            div.innerHTML = `
                <input type="checkbox" name="cert_ids" value="${result.id}" id="cert_${result.id}" checked>
                <label for="cert_${result.id}">${result.name}</label>
            `;
            container.appendChild(div);

            closeModal('certModal');
            document.getElementById('certForm').reset();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>

{% include "footer.html" %}
